<meta charset="utf-8">
<div style="background:#fee; margin: 1em 4em 4em 4em; border:solid 4px red; padding: 0em 4ex 1em 4ex;">
<p style="font-size:160%; font-weight:bold; color:red;">WARNING<br>Content Under Development</p>
See <a href="https://github.com/RayTracing/raytracinginoneweekend/releases">release page</a> for
latest official PDF version.</div>




                              **Chapter 8: Sampling Lights Directly**

The problem with sampling almost uniformly over directions is that lights are not sampled any
more than unimportant directions. We could use shadow rays and separate out direct lighting.
But instead, I’ll just send more rays to the light. We can then use that later to send more rays
in whatever direction we want.
It’s really easy to pick a random direction toward the light; just pick a random point on the light
and send a ray in that direction. But we also need to know the pdf(direction)

. What is that?
For a light of area A,

if we sample uniformly on that light, the pdf

on the surface of the light is
1/A

.

But what is it on the area of the unit sphere that defines directions? Fortunately, there is a
simple correspondence, as outlined in the diagram:
If we look at a small area dA

on the light, the probability of sampling it is p_q(

q

)*dA.

On the
sphere, the probability of sampling the small area dw

on the sphere is p(direction)*dw.

There
is a geometric relationship between dw

and dA:
dw = dA cos(alpha) / (distance(

p,q

)^2)
Since the probability of sampling dw and dA must be the same, we have
p(direction)*cos(alpha)*dA / (distance(

p,q

)^2 ) = p_q(

q

)*dA = dA / A
So
p(direction) = distance(

p,q

)^2 / ( cos(alpha) *A )
If we hack our color function to sample the light in a very hard-coded fashion just to check that
math and get the concept, we can add it (see the highlighted region):
With 10 samples per pixel this yields:
This is about what we would expect from something that samples only the light sources, so this
appears to work. The noisy pops around the light on the ceiling are because the light is
two-sided and there is a small space between light and ceiling. We probably want to have the
light just emit down. We can do that by letting the emitted member function of hitable

take
extra information:
We also need to flip the light so its normals point in the -y direction and we get:



<!-- Markdeep: -->
<style class="fallback">body{visibility:hidden;white-space:pre;font-family:monospace}</style>
<script src="markdeep.min.js"></script>
<script src="https://casual-effects.com/markdeep/latest/markdeep.min.js"></script>
<script>window.alreadyProcessedMarkdeep||(document.body.style.visibility="visible")</script>
